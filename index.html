<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify - Web Player: Music for everyone</title>
    <link rel="icon" href="https://open.spotifycdn.com/cdn/images/favicon.0f31d2ea.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="utility.css">
    <!-- <script src="script.js"></script> -->
</head>

<body>
    <nav class="flex">
        <div class="left-nav flex justify-center align-center">
            <img id="nav-logo" width="32" height="32" src="asssets/logo.svg" alt="LOGO" sizes="" srcset="">
            <div class="flex justify-center align-center" id="home-logo-div">
                <img id="home-logo-img" width="24" height="24" src="asssets/home.svg" alt="HOME-LOGO" srcset="">
            </div>
            <img width="32" height="32" id="search-svg" src="asssets/search.svg" alt="" srcset="">
            <input id="nav-search-bar" type="text no-deco" name="" placeholder="Search your mood">
            <div id="search-pipe" class="font-16 flex justify-center align-center">|</div>
            <img width="25" height="25" id="browse-svg" src="asssets/browse.svg" alt="BROWSE_LOGO" srcset="">
        </div>
        <div class="right-nav flex justify-center align-center">
            <button type="button" id="sign-up-btn" class="w-text font-16 color-80">Explore premium</button>
            <a href="#" id="instal-link" class="scale-anime fw-700 w-text no-deco font-14 color-80 flex">
                <img id="nav-right-dwnld-svg" width="16" height="16" class="flex justify-center align-center"
                    src="asssets/download.svg" alt="icon">
                Install App
            </a>
            <a href="#" class="scale-anime fw-700 w-text no-deco font-14 color-80">Sign Up</a>
        </div>
    </nav>

    <main id="main-sec">

        <section id="left-sec">
            <div id="left-whole-div" class="">
                <h2 class="playlist-name w-text font-16">Your playlist </h2>
                
                <div class="song-pl">

                </div>
            </div>
        </section>

        <section id="right-sec">
            <h2 class="w-text ">Trending Songs</h2>

            <div class="card-container">       
                
            </div>
        </section>

    </main>

    <footer class="">
        <div class="upper-div">
            <div class="info-text">Playing : </div>
            <div class="seek-btns">
                <img width="20" height="20" id="previous-btn" src="asssets/previous-button-svgrepo-com.svg"
                    alt="previous" srcset="">
                <img width="20" height="20" id="play-btn" src="asssets/play-button-svgrepo-com.svg" alt="play">
                <img width="20" height="20" id="next-btn" src="asssets/next-button-svgrepo-com.svg" alt="next"
                    srcset="">
            </div>
            <div class="volume">
                <img width="20" height="20" id="volume-svg" src="asssets/volume-max-svgrepo-com.svg" alt="volume" srcset="">
                <input type="range" name="volume" id="volume-range" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="timer">00:00 / 00:00</div>
        </div>
        <div class="seek-bar">
            <div class="time-bar"></div>
            <div class="dot"></div>
        </div>
    </footer>

    <script>
        console.log("java script");

let currentFolder;
let audio = new Audio();
let currentBtn = null;
let songs = [];

// Extract song names (remove extensions, decode URI)
function extractSongName(url) {
    return decodeURIComponent(url.split("/").pop())
        .replace(/\.(mp3|webm)$/i, "")
        .trim();
}

// Fetch songs from a given folder
async function getSongs(folder) {
    currentFolder = folder;

    let a = await fetch(`http://127.0.0.1:3000/${folder}/`);
    let response = await a.text();

    let div = document.createElement("div");
    div.innerHTML = response;

    let aTags = div.getElementsByTagName("a");
    songs = [];

    for (let element of aTags) {
        if (["webm", "mp3"].some(ext => element.href.endsWith(ext))) {
            songs.push({
                url: element.href, // full URL
                name: extractSongName(element.href)
            });
        }
    }

    let songList = document.querySelector(".song-pl");
    songList.innerHTML = "";

    for (const [index, song] of songs.entries()) {
        let div = document.createElement("div");
        div.className = "song";
        div.innerHTML = `
            <img width="30" height="30" class="invert" src="asssets/music-note-circle-svgrepo-com.svg">
            <div class="song-pl-info"><span>${song.name}</span></div>
            <div class="play-btn-pl">
                <img width="30" height="30" class="invert pl-btn" src="asssets/play-button-svgrepo-com.svg">
            </div>
        `;

        let playBtn = div.querySelector(".play-btn-pl");
        let playIcon = playBtn.querySelector("img");

        playBtn.addEventListener("click", () => {
            let songInfo = document.querySelector(".info-text");

            if (audio.src === song.url && !audio.paused) {
                audio.pause();
                playIcon.src = "asssets/play-button-svgrepo-com.svg";
                seekplay.src = "asssets/play-button-svgrepo-com.svg";
                currentBtn = null;
            } else {
                if (currentBtn) {
                    currentBtn.querySelector("img").src = "asssets/play-button-svgrepo-com.svg";
                }
                audio.src = song.url;
                audio.play();

                playIcon.src = "asssets/pause-button-svgrepo-com.svg";
                seekplay.src = "asssets/pause-button-svgrepo-com.svg";

                songInfo.textContent = "Playing : " + song.name;
                currentBtn = playBtn;
            }
        });

        songList.appendChild(div);
    }
    return songs;
}

// Format seconds -> mm:ss
function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "00:00";
    let minutes = Math.floor(seconds / 60);
    let secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, "0")}`;
}

// Fetch all albums (folders in /songs)
async function getAlbums() {
    let a = await fetch(`http://127.0.0.1:3000/songs/`);
    let response = await a.text();

    let div = document.createElement("div");
    div.innerHTML = response;

    let anchors = div.getElementsByTagName("a");
    let array = Array.from(anchors);

    let cardContainer = document.querySelector(".card-container");

    for (let element of array) {
        if (element.href.includes("/songs/") && !element.href.endsWith("../")) {
            let folder = element.href.split("/songs/").pop().replace(/\/$/, ""); // clean

            try {
                let info = await fetch(`songs/${folder}/info.json`);
                let response = await info.json();

                cardContainer.insertAdjacentHTML("beforeend", `
                    <div class="card" data-folder="songs/${folder}">
                        <img width="180" height="170" src="asssets/card-img.jpg" alt="" class="card-img">
                        <div class="card-play-btn">
                            <img width="20" height="20" src="asssets/play-1001-svgrepo-com.svg" alt="play">
                        </div>
                        <div class="card-text">
                            <h3 class="album-name">${response.title}</h3>
                            <p>${response.description}</p>
                        </div>
                    </div>
                `);
            } catch (err) {
                console.warn("Missing info.json for", folder);
            }
        }
    }

    let cards = Array.from(document.getElementsByClassName("card"));
    for (const element of cards) {
        element.addEventListener("click", async (item) => {
            let folder = item.currentTarget.dataset.folder;
            songs = await getSongs(folder);
        });
    }
}

// Main app logic
async function main() {
    await getAlbums();

    // Audio ended
    audio.addEventListener("ended", () => {
        if (currentBtn) {
            currentBtn.querySelector("img").src = "asssets/play-button-svgrepo-com.svg";
            currentBtn = null;
        }
    });

    // Timer + progress bar
    audio.addEventListener("timeupdate", () => {
        document.querySelector(".timer").textContent =
            `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;

        document.querySelector(".dot").style.left =
            (audio.currentTime / audio.duration) * 100 + "%";
    });

    document.querySelector(".time-bar").addEventListener("click", (e) => {
        let percent = (e.offsetX / e.target.getBoundingClientRect().width);
        document.querySelector(".dot").style.left = (percent * 100) + "%";
        audio.currentTime = audio.duration * percent;
    });

    // Volume controls
    const volumeSlider = document.getElementById("volume-range");
    let volumeSVG = document.getElementById("volume-svg");
    let lastVolume = volumeSlider.value;

    volumeSlider.addEventListener("input", () => {
        audio.volume = volumeSlider.value;
        volumeSVG.src = audio.volume == 0
            ? "asssets/volume-xmark-svgrepo-com.svg"
            : "asssets/volume-max-svgrepo-com.svg";
    });

    volumeSVG.addEventListener("click", () => {
        if (audio.volume > 0) {
            lastVolume = audio.volume;
            audio.volume = 0;
            volumeSlider.value = 0;
            volumeSVG.src = "asssets/volume-xmark-svgrepo-com.svg";
        } else {
            audio.volume = lastVolume || 1;
            volumeSlider.value = audio.volume;
            volumeSVG.src = "asssets/volume-max-svgrepo-com.svg";
        }
    });

    // Controls
    let seeknext = document.getElementById("next-btn");
    let seekprev = document.getElementById("previous-btn");
    seekplay = document.getElementById("play-btn");

    seekplay.addEventListener("click", () => {
        if (audio.paused) {
            audio.play();
            seekplay.src = "asssets/pause-button-svgrepo-com.svg";
        } else {
            audio.pause();
            seekplay.src = "asssets/play-button-svgrepo-com.svg";
        }
    });

    // Previous
    seekprev.addEventListener("click", () => {
        if (!songs.length) return;

        let currentIndex = songs.findIndex(s => s.url === audio.src);
        if (currentIndex === -1) currentIndex = 0;

        let prevIndex = (currentIndex - 1 + songs.length) % songs.length;
        let prevSong = songs[prevIndex];

        if (currentBtn) {
            currentBtn.querySelector("img").src = "asssets/play-button-svgrepo-com.svg";
        }

        audio.src = prevSong.url;
        audio.play();

        let allSongs = document.querySelectorAll(".song");
        let targetBtn = allSongs[prevIndex].querySelector(".play-btn-pl");
        let playIcon = targetBtn.querySelector("img");

        playIcon.src = "asssets/pause-button-svgrepo-com.svg";
        seekplay.src = "asssets/pause-button-svgrepo-com.svg";

        document.querySelector(".info-text").textContent =
            "Playing : " + prevSong.name;

        currentBtn = targetBtn;
    });

    // Next
    seeknext.addEventListener("click", () => {
        if (!songs.length) return;

        let currentIndex = songs.findIndex(s => s.url === audio.src);
        if (currentIndex === -1) currentIndex = 0;

        let nextIndex = (currentIndex + 1) % songs.length;
        let nextSong = songs[nextIndex];

        if (currentBtn) {
            currentBtn.querySelector("img").src = "asssets/play-button-svgrepo-com.svg";
        }

        audio.src = nextSong.url;
        audio.play();

        let allSongs = document.querySelectorAll(".song");
        let targetBtn = allSongs[nextIndex].querySelector(".play-btn-pl");
        let playIcon = targetBtn.querySelector("img");

        playIcon.src = "asssets/pause-button-svgrepo-com.svg";
        seekplay.src = "asssets/pause-button-svgrepo-com.svg";

        document.querySelector(".info-text").textContent =
            "Playing : " + nextSong.name;

        currentBtn = targetBtn;
    });
}

main();

    </script>

</body>

</html>